<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { background-color: #f0f2f5; font-family: sans-serif; padding-bottom: 70px; }
    .header { background-color: #90ee90; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .nav-tabs-custom { display: flex; background: white; position: sticky; top: 54px; z-index: 1000; border-bottom: 2px solid #ddd; }
    .tab-item { flex: 1; text-align: center; padding: 12px; font-weight: bold; cursor: pointer; color: #666; }
    .tab-item.active { color: #28a745; border-bottom: 3px solid #28a745; background: #f8fff8; }
    .container { padding: 12px; }
    .page { display: none; }
    .page.active { display: block; }
    .card { background: white; border-radius: 12px; padding: 15px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .f-group { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .f-group label { width: 35%; font-size: 12px; font-weight: bold; color: #444; }
    .f-group input { width: 55%; border: none; outline: none; background: transparent; font-size: 14px; }
    .table-responsive { max-height: 60vh; overflow-y: auto; border-radius: 8px; font-size: 10px; border: 1px solid #eee; }
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index:10001; }
    #reader { width: 100%; margin-bottom: 10px; border-radius: 12px; overflow: hidden; }
  </style>
</head>
<body>

  <div id="loader"><b>MEMPROSES DATA...</b></div>
  <div class="header">SO HARIAN WH MAKASSAR</div>

  <div class="nav-tabs-custom">
    <div class="tab-item active" onclick="switchTab('so')">üìù INPUT SO</div>
    <div class="tab-item" onclick="switchTab('monitoring')">üìä MONITORING</div>
  </div>

  <div class="container text-uppercase">
    <div id="page-so" class="page active">
      <div id="reader" style="display:none;"></div>
      <div class="card">
        <form id="soForm">
          <div class="f-group"><label>TGL SO</label><input type="date" id="tgl"></div>
          <div class="f-group"><label>NIK</label><input type="text" id="nik" placeholder="INPUT NIK"></div>
          <div class="f-group"><label>NAMA</label><input type="text" id="nama" readonly placeholder="-"></div>
          <div class="f-group"><label>BARCODE</label><input type="text" id="barcode" placeholder="SCAN/INPUT"><button type="button" onclick="startScan()" style="border:none;background:none;font-size:18px;">üì∑</button></div>
          <div class="f-group"><label>PLU</label><input type="text" id="plu" placeholder="INPUT PLU"></div>
          <div class="f-group"><label>DESCP</label><input type="text" id="descp" readonly placeholder="-"></div>
          <div class="f-group"><label>LOKASI</label><input type="text" id="lokasi" readonly placeholder="-"></div>
          <div class="f-group"><label>C2</label><input type="text" id="c2" readonly placeholder="-"></div>
          <div class="f-group"><label>TAG</label><input type="text" id="tag" readonly placeholder="-"></div>
          <div class="f-group"><label>OH</label><input type="text" id="oh" readonly placeholder="0" style="color:blue; font-weight:bold;"></div>
          <div class="f-group"><label>QTY PCS</label><input type="number" id="qty" placeholder="0"></div>
        </form>
      </div>
      <div class="btn-grid">
        <button onclick="simpanKeAntrean()" class="btn-act" style="background:#007bff; width:48%; border-radius:8px; color:white; padding:10px; border:none; font-weight:bold;">SAVE DATA</button>
        <button onclick="refreshForm()" class="btn-act" style="background:#6c757d; width:48%; border-radius:8px; color:white; padding:10px; border:none; font-weight:bold;">REFRESH</button>
        <button id="btnKirimServer" onclick="kirimSemuaKeServer()" class="btn-act" style="width: 100%; background:#ff5722; margin-top:10px; display:none; border-radius:8px; color:white; padding:10px; border:none; font-weight:bold;">üöÄ KIRIM KE SERVER</button>
      </div>
    </div>

    <div id="page-monitoring" class="page">
      <div class="card">
        <input type="date" id="filterTgl" class="form-control mb-2">
        <button onclick="muatMonitoring()" class="btn btn-primary w-100">CARI DATA</button>
      </div>
      <div class="table-responsive mt-2">
        <table class="table table-sm table-striped">
          <thead class="table-dark"><tr><th>PLU</th><th>DESCP</th><th>OH</th><th>FISIK</th><th>SEL</th></tr></thead>
          <tbody id="bodyMonitoring"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0bfJTZ8nd4KT7tRqJqPMgI9ZBJYy_r4DpB4u10jK8rWKLnUCVfMubDHzRnVLJGHqb/exec"; 
const AUTHORIZED_NIK = ["06080176", "06040353", "01060319", "08081171", "10030732", "10062381", "03070494"];

let ANTREAN_DATA = JSON.parse(localStorage.getItem('so_antrean')) || [];
let DATA_P = [], DATA_I = [];
let html5QrCode;

window.onload = function() {
  const t = new Date();
  document.getElementById('tgl').valueAsDate = t;
  loadDataFromServer();
};

function loadDataFromServer() {
  document.getElementById('loader').style.display = 'flex';
  fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "getData" }) })
  .then(res => res.json())
  .then(res => {
    DATA_P = res.petugas || [];
    DATA_I = res.items || [];
    document.getElementById('loader').style.display = 'none';
    updateTombolKirim();
  })
  .catch(() => {
    document.getElementById('loader').style.display = 'none';
    alert("Gagal memuat data master. Periksa koneksi internet.");
  });
}

// LOGIKA INPUT NIK - MUNCUL NAMA OTOMATIS
document.getElementById('nik').addEventListener('input', function() {
  const val = this.value.trim();
  if (!DATA_P.length) return;
  let f = DATA_P.find(r => r && String(r[0]).trim() === val);
  document.getElementById('nama').value = f ? f[1] : "-";
});

// LOGIKA CARI BARANG - MUNCUL SEMUA KOLOM OTOMATIS
function cariBarang(val, idx, tipe) {
  const searchVal = String(val).trim();
  if (!searchVal || !DATA_I.length) return;
  
  let f = DATA_I.find(r => r && String(r[idx]).trim() === searchVal);
  if (f) {
    document.getElementById('barcode').value = f[0] || "";
    document.getElementById('plu').value     = f[1] || "";
    document.getElementById('descp').value   = f[2] || "";
    document.getElementById('lokasi').value  = f[3] || "";
    document.getElementById('c2').value      = f[4] || "";
    document.getElementById('tag').value     = f[5] || "";
    document.getElementById('oh').value      = f[6] || 0;
    setTimeout(() => document.getElementById('qty').focus(), 300);
  } else {
    alert(tipe + " TIDAK DITEMUKAN!");
  }
}

document.getElementById('barcode').onchange = function() { cariBarang(this.value, 0, "BARCODE"); };
document.getElementById('plu').onchange = function() { cariBarang(this.value, 1, "PLU"); };

// FUNGSI DASAR APLIKASI
function switchTab(tab) {
  const nik = document.getElementById('nik').value.trim();
  if (tab === 'monitoring' && !AUTHORIZED_NIK.includes(nik)) {
    alert("AKSES DITOLAK!"); return;
  }
  document.querySelectorAll('.tab-item, .page').forEach(el => el.classList.remove('active'));
  if (tab === 'so') {
    document.querySelector('.tab-item:nth-child(1)').classList.add('active');
    document.getElementById('page-so').classList.add('active');
  } else {
    document.querySelector('.tab-item:nth-child(2)').classList.add('active');
    document.getElementById('page-monitoring').classList.add('active');
  }
}

function simpanKeAntrean() {
  const nama = document.getElementById('nama').value;
  const plu = document.getElementById('plu').value;
  const qty = document.getElementById('qty').value;
  if (nama === "-" || !plu || !qty) { alert("Data tidak lengkap!"); return; }

  const d = {
    tgl: document.getElementById('tgl').value,
    nik: document.getElementById('nik').value,
    nama: nama, barcode: document.getElementById('barcode').value,
    plu: plu, descp: document.getElementById('descp').value,
    lokasi: document.getElementById('lokasi').value,
    c2: document.getElementById('c2').value, tag: document.getElementById('tag').value,
    oh: document.getElementById('oh').value, qty: qty
  };
  ANTREAN_DATA.push(d);
  localStorage.setItem('so_antrean', JSON.stringify(ANTREAN_DATA));
  updateTombolKirim();
  ['barcode','plu','descp','lokasi','c2','tag','oh','qty'].forEach(id => document.getElementById(id).value = "");
  document.getElementById('barcode').focus();
}

function kirimSemuaKeServer() {
  const btn = document.getElementById('btnKirimServer');
  btn.innerText = "‚è≥ MENGIRIM..."; btn.disabled = true;
  fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "saveBulk", data: ANTREAN_DATA }) })
  .then(() => {
    alert("‚úÖ BERHASIL!");
    ANTREAN_DATA = []; localStorage.removeItem('so_antrean');
    updateTombolKirim(); btn.disabled = false;
  }).catch(() => { alert("Gagal!"); btn.disabled = false; });
}

function updateTombolKirim() {
  const btn = document.getElementById('btnKirimServer');
  btn.style.display = ANTREAN_DATA.length > 0 ? "block" : "none";
  btn.innerText = "üöÄ KIRIM " + ANTREAN_DATA.length + " DATA";
}

function startScan() {
  document.getElementById('reader').style.display = 'block';
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
    document.getElementById('barcode').value = txt;
    cariBarang(txt, 0, "BARCODE");
    html5QrCode.stop().then(() => document.getElementById('reader').style.display = 'none');
  });
}

function refreshForm() { location.reload(); }
</script>
</body>
</html>
